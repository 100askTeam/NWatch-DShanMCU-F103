// SPDX-License-Identifier: GPL-3.0-only
/*
 * Copyright (c) 2008-2023 100askTeam : Dongshan WEI <weidongshan@qq.com> 
 * Discourse:  https://forums.100ask.net
 */
 
/*  Copyright (C) 2008-2023 ???????????
 *  All rights reserved
 *
 * ????: ????????, ????????, ???????(???????),????????!
 * ????: ????????, ????????, ???????????!
 * 
 * ????:driver_color_led.c
 * ?????GPL V3??, ?????
 * ???????   : https://www.100ask.net
 * ???????   : https://forums.100ask.net
 * ?????B?    : https://space.bilibili.com/275908810
 * ???????? : DShanMCU-F103
 * ???????   : https://100ask.taobao.com
 * ????(E-mail): weidongshan@qq.com
 *
 *          ????,?????
 *  
 * ????     ???           ??        ????
 *-----------------------------------------------------
 * 2023.08.04      v01         ????      ????
 *-----------------------------------------------------
 */

#include "driver_ir_receiver.h"
#include "driver_lcd.h"
#include "driver_timer.h"
#include "stm32f1xx_hal.h"
#include "tim.h"

/* ç¯å½¢ç¼“å†²åŒ? ç”¨æ¥ä¿å­˜è§£æå‡ºæ¥çš„æŒ‰é”?å¯ä»¥é˜²æ­¢ä¸¢å¤± */
#define BUF_LEN 128
static unsigned char g_KeysBuf[BUF_LEN];
static int g_KeysBuf_R, g_KeysBuf_W;

static uint64_t g_IRReceiverIRQ_Timers[68];
static int g_IRReceiverIRQ_Cnt = 0;

#define NEXT_POS(x) ((x+1) % BUF_LEN)

/* è¾…åŠ©å‡½æ•° */

/**********************************************************************
 * å‡½æ•°åç§°ï¼?isKeysBufEmpty
 * åŠŸèƒ½æè¿°ï¼?ç¯å½¢ç¼“å†²åŒºæ˜¯å¦ç©º
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š 1-ç©? 0-éç©º
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static int isKeysBufEmpty(void)
{
	return (g_KeysBuf_R == g_KeysBuf_W);
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?isKeysBufFull
 * åŠŸèƒ½æè¿°ï¼?ç¯å½¢ç¼“å†²åŒºæ˜¯å¦æ»¡
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š 1-æ»? 0-æœªæ»¡
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static int isKeysBufFull(void)
{
	return (g_KeysBuf_R == NEXT_POS(g_KeysBuf_W));
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?PutKeyToBuf
 * åŠŸèƒ½æè¿°ï¼?æŠŠæŒ‰é”®æ•°æ®å†™å…¥ç¯å½¢ç¼“å†²åŒº
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š æ—
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static void PutKeyToBuf(unsigned char key)
{
	if (!isKeysBufFull())
	{
		g_KeysBuf[g_KeysBuf_W] = key;
		g_KeysBuf_W = NEXT_POS(g_KeysBuf_W);
	}
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?GetKeyFromBuf
 * åŠŸèƒ½æè¿°ï¼?ä»ç¯å½¢ç¼“å†²åŒºè¯»å–æŒ‰é”®æ•°æ®
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š 0xff - è¯»ä¸åˆ°æ•°æ? å…¶ä»–å€?æŒ‰é”®å€?deviceæˆ–key)
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static unsigned char GetKeyFromBuf(void)
{
	unsigned char key = 0xff;
	if (!isKeysBufEmpty())
	{
		key = g_KeysBuf[g_KeysBuf_R];
		g_KeysBuf_R = NEXT_POS(g_KeysBuf_R);
	}
	return key;
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_IRQTimes_Parse
 * åŠŸèƒ½æè¿°ï¼?è§£æä¸­æ–­å›è°ƒå‡½æ•°é‡Œè®°å½•çš„æ—¶é—´åºåˆ—,å¾—åˆ°çš„deviceå’Œkeyæ”¾å…¥ç¯å½¢ç¼“å†²åŒ
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š 0 - æˆåŠŸ, (-1) - å¤±è´¥
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static int IRReceiver_IRQTimes_Parse(void)
{
	uint64_t time;
	int i;
	int m, n;
	unsigned char datas[4];
	unsigned char data = 0;
	int bits = 0;
	int byte = 0;

	/* 1. åˆ¤æ–­å‰å¯¼ç ?: 9msçš„ä½è„‰å†², 4.5msé«˜è„‰å†? */
	time = g_IRReceiverIRQ_Timers[1] - g_IRReceiverIRQ_Timers[0];
	if (time < 8000000 || time > 10000000)
	{
		return -1;
	}

	time = g_IRReceiverIRQ_Timers[2] - g_IRReceiverIRQ_Timers[1];
	if (time < 3500000 || time > 55000000)
	{
		return -1;
	}

	/* 2. è§£ææ•°æ® */
	for (i = 0; i < 32; i++)
	{
		m = 3 + i*2;
		n = m+1;
		time = g_IRReceiverIRQ_Timers[n] - g_IRReceiverIRQ_Timers[m];
		data <<= 1;
		bits++;
		if (time > 1000000)
		{
			/* å¾—åˆ°äº†æ•°æ? */
			data |= 1;
		}

		if (bits == 8)
		{
			datas[byte] = data;
			byte++;
			data = 0;
			bits = 0;
		}
	}

	/* åˆ¤æ–­æ•°æ®æ­£è¯¯ */
	datas[1] = ~datas[1];
	datas[3] = ~datas[3];
	
	if ((datas[0] != datas[1]) || (datas[2] != datas[3]))
	{
        g_IRReceiverIRQ_Cnt = 0;
        return -1;
	}

	PutKeyToBuf(datas[0]);
	PutKeyToBuf(datas[2]);
    return 0;
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?isRepeatedKey
 * åŠŸèƒ½æè¿°ï¼?è§£æä¸­æ–­å›è°ƒå‡½æ•°é‡Œè®°å½•çš„æ—¶é—´åºåˆ—,åˆ¤æ–­æ˜¯å¦é‡å¤ç 
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š 1 - æ˜? (0) - ä¸æ˜¯
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
static int isRepeatedKey(void)
{
	uint64_t time;

	/* 1. åˆ¤æ–­é‡å¤ç ?: 9msçš„ä½è„‰å†², 2.25msé«˜è„‰å†? */
	time = g_IRReceiverIRQ_Timers[1] - g_IRReceiverIRQ_Timers[0];
	if (time < 8000000 || time > 10000000)
	{
		return 0;
	}

	time = g_IRReceiverIRQ_Timers[2] - g_IRReceiverIRQ_Timers[1];
	if (time < 2000000 || time > 2500000)
	{
		return 0;
	}	

	return 1;
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_IRQ_Callback
 * åŠŸèƒ½æè¿°ï¼?çº¢å¤–æ¥æ”¶å™¨çš„ä¸­æ–­å›è°ƒå‡½æ•°,è®°å½•ä¸­æ–­æ—¶åˆ»
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š æ—
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
void IRReceiver_IRQ_Callback(void)
{
    uint64_t time;
    static uint64_t pre_time = 0;

        
	/* 1. è®°å½•ä¸­æ–­å‘ç”Ÿçš„æ—¶åˆ?*/	
	time = system_get_ns();
    
    /* ä¸€æ¬¡æŒ‰é”®çš„æœ€é•¿æ•°æ?= å¼•å¯¼ç ?+ 32ä¸ªæ•°æ?1" = 9+4.5+2.25*32 = 85.5ms
     * å¦‚æœå½“å‰ä¸­æ–­çš„æ—¶åˆ? ä¸¾ä¾‹ä¸Šæ¬¡ä¸­æ–­çš„æ—¶åˆ»è¶…è¿‡è¿™ä¸ªæ—¶é—? ä»¥å‰çš„æ•°æ®å°±æŠ›å¼ƒ
     */
    if (time - pre_time > 100000000) 
    {
        g_IRReceiverIRQ_Cnt = 0;
    }
    pre_time = time;
    
	g_IRReceiverIRQ_Timers[g_IRReceiverIRQ_Cnt] = time;

	/* 2. ç´¯è®¡ä¸­æ–­æ¬¡æ•° */
	g_IRReceiverIRQ_Cnt++;

	/* 3. æ¬¡æ•°è¾¾æ ‡å? è§£ææ•°æ®, æ”¾å…¥buffer */
	if (g_IRReceiverIRQ_Cnt == 4)
	{
		/* æ˜¯å¦é‡å¤ç ?*/
		if (isRepeatedKey())
		{
			/* device: 0, val: 0, è¡¨ç¤ºé‡å¤ç ?*/
			PutKeyToBuf(0);
			PutKeyToBuf(0);
			g_IRReceiverIRQ_Cnt = 0;
		}
	}
	if (g_IRReceiverIRQ_Cnt == 68)
	{
		IRReceiver_IRQTimes_Parse();
		g_IRReceiverIRQ_Cnt = 0;
	}
}


/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_Init
 * åŠŸèƒ½æè¿°ï¼?çº¢å¤–æ¥æ”¶å™¨çš„åˆå§‹åŒ–å‡½æ•
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š æ—
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
void IRReceiver_Init(void)
{
    /* PA10åœ¨MX_GPIO_Init()ä¸­å·²ç»è¢«é…ç½®ä¸ºåŒè¾¹æ²¿è§¦å‘, å¹¶ä½¿èƒ½äº†ä¸­æ–­ */
#if 0
    /*Configure GPIO pin : PB10 */
    GPIO_InitStruct.Pin = GPIO_PIN_10;
    GPIO_InitStruct.Mode = GPIO_MODE_EVT_RISING_FALLING;
    GPIO_InitStruct.Pull = GPIO_PULLUP;
    HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);
#endif
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_Read
 * åŠŸèƒ½æè¿°ï¼?çº¢å¤–æ¥æ”¶å™¨çš„è¯»å–å‡½æ•°
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?pDev  - ç”¨æ¥ä¿å­˜è®¾å¤‡ID
 *            pData - ç”¨æ¥ä¿å­˜æŒ‰é”®ç 
 * è¿?å›?å€¼ï¼š 0 - æˆåŠŸ, (-1) - å¤±è´¥(æ— æ•°æ?
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
int IRReceiver_Read(uint8_t *pDev, uint8_t *pData)
{
    if (isKeysBufEmpty())
        return -1;
    
    *pDev  = GetKeyFromBuf();
    *pData = GetKeyFromBuf();
    return 0;
}

/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_CodeToString
 * åŠŸèƒ½æè¿°ï¼?æŠŠæ¥æ”¶åˆ°çš„æŒ‰é”®ç è½¬æ¢ä¸ºæŒ‰é”®åå­
 * è¾“å…¥å‚æ•°ï¼?code - æŒ‰é”®ç 
 * è¾“å‡ºå‚æ•°ï¼?æ—
 * è¿?å›?å€¼ï¼š NULL - æœªè¯†åˆ«çš„æŒ‰é”®ç ? å…¶ä»–å€?- æŒ‰é”®åå­—
 * ä¿®æ”¹æ—¥æœŸï¼?     ç‰ˆæœ¬å?    ä¿®æ”¹äº?      ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04	     V1.0	  éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
const char *IRReceiver_CodeToString(uint8_t code)
{
    const uint8_t codes[]= {0xa2, 0xe2, 0x22, 0x02, 0xc2, 0xe0, 0xa8, 0x90, \
                            0x68, 0x98, 0xb0, 0x30, 0x18, 0x7a, 0x10, 0x38, \
                            0x5a, 0x42, 0x4a, 0x52, 0x00};
    const char *names[]= {"Power", "Menu", "Test", "+", "Return", "Left", "Play", "Right", \
                            "0", "-", "C", "1", "2", "3", "4", "5", \
                            "6", "7", "8", "9", "Repeat"};
    int i;
    
    for (i = 0; i < sizeof(codes)/sizeof(codes[0]); i++)
    {
        if (code == codes[i])
        {
            return names[i];
        }
    }
    return "Error";
}


/**********************************************************************
 * å‡½æ•°åç§°ï¼?IRReceiver_Test
 * åŠŸèƒ½æè¿°ï¼?çº¢å¤–æ¥æ”¶å™¨æµ‹è¯•ç¨‹åº
 * è¾“å…¥å‚æ•°ï¼?æ—
 * è¾“å‡ºå‚æ•°ï¼?æ—
 *            æ—
 * è¿?å›?å€¼ï¼š æ—
 * ä¿®æ”¹æ—¥æœŸ        ç‰ˆæœ¬å?    ä¿®æ”¹äº?       ä¿®æ”¹å†…å®¹
 * -----------------------------------------------
 * 2023/08/04        V1.0     éŸ¦ä¸œå±?      åˆ›å»º
 ***********************************************************************/
void IRReceiver_Test(void)
{
    uint8_t dev, data;
    int len;
	
    IRReceiver_Init();

    while (1)
    {
        LCD_PrintString(0, 0, "IR Receiver: ");        
        LCD_PrintString(0, 2, "Device  Data");

        if (!IRReceiver_Read(&dev, &data))
        {
            LCD_PrintString(0, 4, "                ");
            LCD_PrintHex(0, 4, dev, 1);
            LCD_PrintHex(8, 4, data, 1);
            LCD_PrintString(0, 6, "                ");
            len = LCD_PrintString(0, 6, "Key name: ");
            LCD_PrintString(len, 6, IRReceiver_CodeToString(data));
        }
    }
}
